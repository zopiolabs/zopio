#!/usr/bin/env sh

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

if [ "$CI" = "true" ]; then
  echo "CI environment detected. Skipping pre-rebase hook."
  exit 0
fi

echo "ğŸ”„ Running pre-rebase checks..."
echo "â„¹ï¸  This hook ensures code quality before rebasing"

# Run Turbo lint on affected packages
echo "ğŸ” Running turbo affected lint..."
echo "   - Linting only packages affected by your changes"
pnpm turbo run lint --filter=...[origin/develop] && {
  echo "   âœ“ Affected packages lint passed"
} || {
  echo "${RED}âŒ Turbo lint checking failed${NC}"
  echo "   Please fix linting issues before rebasing"
  exit 1
}

# Run Turbo type checking on affected packages
echo "ğŸ” Running turbo affected type check..."
echo "   - Verifying TypeScript types of affected packages"
pnpm turbo run typecheck --filter=...[origin/develop] && {
  echo "   âœ“ Affected packages type check passed"
} || {
echo "${RED}âŒ Turbo type checking failed${NC}"
echo "   Please fix type errors before rebasing"
exit 1
}

# Run unit tests on affected packages
echo "ğŸ§ª Running unit tests on affected packages..."
echo "   - Verifying that all tests pass before rebasing"
pnpm test --changed && {
  echo "   âœ“ Affected packages unit tests passed"
} || {
  echo "${RED}âŒ Unit tests failed${NC}"
  echo "   Please fix failing tests before rebasing"
  exit 1
}

echo "${GREEN}âœ… All pre-rebase checks passed!${NC}"
echo "   Your code is ready to be rebased"
